---
import PageLayout from '../layouts/PageLayout.astro'
import '../styles/tools-common.css'
---

<PageLayout title="图像去色/反色">
    <div class="tool-container">
        <div class="upload-area" id="uploadArea">
            <p>点击选择图片、拖拽图片到此处或粘贴图片 (Ctrl+V)</p>
            <input type="file" id="fileInput" accept="image/*" hidden />
            <button class="btn primary mt-4" id="selectButton">选择图片</button>
        </div>
        
        <div class="preview-container" id="previewContainer" style="display: none;">
            <h3>原图</h3>
            <img id="originalImage" class="block" style="margin: 15px auto" src="" alt="Original image" />
            
            <div class="conversion-options">
                <h3>选择转换方式</h3>
                <div class="options">
                    <label class="radio-btn">
                        <input type="radio" name="conversionType" value="grayscale" checked /> 
                        黑白图像
                    </label>
                    <label class="radio-btn">
                        <input type="radio" name="conversionType" value="invert" /> 
                        反色图像
                    </label>
                </div>
            </div>
            
            <h3>转换后图像</h3>
            <canvas id="convertedCanvas" class="block" style="margin: 15px auto"></canvas>
            
            <div class="actions">
                <button class="btn primary" id="copyButton">复制转换图像</button>
                <button class="btn primary" id="downloadButton">下载转换图像</button>
                <button class="btn primary" id="resetButton">清除选择</button>
            </div>
        </div>
    </div>

    <script>
import { set } from "astro:schema";

        let originalImage: HTMLImageElement | null = null;
        
        // 元素获取
        const uploadArea = document.getElementById('uploadArea')!;
        const fileInput = document.getElementById('fileInput') as HTMLInputElement;
        const selectButton = document.getElementById('selectButton')!;
        const previewContainer = document.getElementById('previewContainer')!;
        const originalImg = document.getElementById('originalImage') as HTMLImageElement;
        const convertedCanvas = document.getElementById('convertedCanvas') as HTMLCanvasElement;
        const downloadButton = document.getElementById('downloadButton')!;
        const resetButton = document.getElementById('resetButton')!;
        const copyButton = document.getElementById('copyButton')!;
        const conversionOptions = document.querySelectorAll('input[name="conversionType"]');
        
        // 事件监听
        selectButton.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFileSelect);
        
        // 拖拽事件
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#007acc';
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.style.borderColor = '#ccc';
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#ccc';
            
            if (e.dataTransfer?.files.length) {
                handleImageFile(e.dataTransfer.files[0]);
            }
        });
        
        // 粘贴事件
        document.addEventListener('paste', (e) => {
            if (e.clipboardData?.files.length) {
                handleImageFile(e.clipboardData.files[0]);
            }
        });
        
        // 下载和重置按钮事件
        downloadButton.addEventListener('click', downloadConvertedImage);
        resetButton.addEventListener('click', resetTool);
        copyButton.addEventListener('click', async (e) => {
            e.preventDefault();
            try {
                const blob = await new Promise<Blob>((resolve) => {
                    convertedCanvas.toBlob((blob) => {
                        if (blob) resolve(blob);
                    }, 'image/png');
                });
                
                await navigator.clipboard.write([
                    new ClipboardItem({ 'image/png': blob })
                ]);

                copyButton.textContent = '✅ 复制成功';
                setTimeout(() => {
                    copyButton.textContent = '复制转换图像';
                }, 2000);
            } catch (err) {
                console.error('Failed to copy image: ', err);
                alert('复制失败，请手动保存图片');
            }
        });
        
        // 转换选项事件监听
        conversionOptions.forEach(option => {
            option.addEventListener('change', convertImage);
        });
        
        // 处理文件选择
        function handleFileSelect(e: Event) {
            const target = e.target as HTMLInputElement;
            if (target.files?.length) {
                handleImageFile(target.files[0]);
            }
        }
        
        // 处理图像文件
        function handleImageFile(file: File) {
            if (!file.type.match('image.*')) {
                alert('请选择图像文件');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                originalImage = new Image();
                originalImage.onload = () => {
                    showPreview();
                    convertImage();
                };
                originalImage.src = e.target!.result as string;
            };
            reader.readAsDataURL(file);
        }
        
        // 显示预览
        function showPreview() {
            originalImg.src = originalImage!.src;
            uploadArea.style.display = 'none';
            previewContainer.style.display = 'block';
        }
        
        // 转换图像（根据选择的选项）
        function convertImage() {
            const selectedOption = (document.querySelector('input[name="conversionType"]:checked') as HTMLInputElement).value || 'grayscale';
            
            const ctx = convertedCanvas.getContext('2d')!;
            convertedCanvas.width = originalImage!.width;
            convertedCanvas.height = originalImage!.height;
            
            // 绘制原图
            ctx.drawImage(originalImage!, 0, 0);
            
            // 获取图像数据
            const imageData = ctx.getImageData(0, 0, convertedCanvas.width, convertedCanvas.height);
            const data = imageData.data;
            
            if (selectedOption === 'grayscale') {
                // 转换为灰度图 (使用标准的 luminance 算法)
                for (let i = 0; i < data.length; i += 4) {
                    const r = data[i];
                    const g = data[i + 1];
                    const b = data[i + 2];
                    
                    // 标准灰度计算公式: 0.299*R + 0.587*G + 0.114*B
                    const gray = 0.299 * r + 0.587 * g + 0.114 * b;
                    
                    data[i] = gray;     // red
                    data[i + 1] = gray; // green
                    data[i + 2] = gray; // blue
                }
            } else if (selectedOption === 'invert') {
                // 反色处理
                for (let i = 0; i < data.length; i += 4) {
                    data[i] = 255 - data[i];     // red
                    data[i + 1] = 255 - data[i + 1]; // green
                    data[i + 2] = 255 - data[i + 2]; // blue
                }
            }
            
            // 应用转换后的数据
            ctx.putImageData(imageData, 0, 0);
        }
        
        // 下载转换后的图像
        function downloadConvertedImage() {
            const link = document.createElement('a');
            const selectedOption = (document.querySelector('input[name="conversionType"]:checked') as HTMLInputElement).value || 'grayscale';
            const fileName = selectedOption === 'grayscale' ? 'grayscale-image.png' : 'inverted-image.png';
            
            link.download = fileName;
            link.href = convertedCanvas.toDataURL('image/png');
            link.click();
        }
        
        // 重置工具
        function resetTool() {
            previewContainer.style.display = 'none';
            uploadArea.style.display = 'block';
            fileInput.value = '';
            originalImg.src = '';
            // 重置选项为默认的黑白选项
            (document.querySelector('input[value="grayscale"]') as HTMLInputElement).checked = true;
        }
    </script>
    
    <style>
        .tool-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .upload-area {
            border: 2px dashed var(--color-border);
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.3s;
        }
        
        .upload-area:hover {
            border-color: var(--color-active);
        }
        
        /*#selectButton {
            background-color: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 15px;
        }
        
        #selectButton:hover {
            background-color: #005a9e;
        }*/
        
        .preview-container {
            text-align: center;
        }
        
        #originalImage, #convertedCanvas {
            max-width: 100%;
            max-height: 400px;
            margin: 15px 0;
            border: 1px solid #ddd;
        }
        
        .conversion-options {
            margin: 20px 0;
        }
        
        .conversion-options h3 {
            margin-bottom: 10px;
        }
        
        .options {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .options label {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 16px;
            cursor: pointer;
        }
        
        .actions {
            margin: 20px 0;
        }
        
        /*.actions button {
            background-color: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 0 10px;
        }
        
        .actions button:hover {
            background-color: #005a9e;
        }*/
    </style>
</PageLayout>
